<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプル家計簿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; }
        .container { max-width: 400px; margin: 0 auto; min-height: 100vh; background: white; }
        .header { background: #2563eb; color: white; padding: 1rem; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .nav-btn { background: none; border: none; color: #bfdbfe; font-size: 1.2rem; padding: 0.25rem 0.5rem; cursor: pointer; }
        .nav-btn:hover { color: white; }
        .title { font-size: 1.25rem; font-weight: bold; }
        .month-display { text-align: center; color: #bfdbfe; font-size: 0.875rem; }
        .section { padding: 1rem; border-bottom: 1px solid #e5e7eb; background: white; }
        .week-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .week-btn { padding: 0.5rem; border: none; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; cursor: pointer; line-height: 1.2; }
        .week-btn.active { background: #2563eb; color: white; }
        .week-btn.inactive { background: #f3f4f6; color: #374151; }
        .week-title { font-weight: 600; margin-bottom: 0.1rem; }
        .week-date { font-size: 0.625rem; color: inherit; opacity: 0.8; }
        .budget-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .budget-card { padding: 0.75rem; border-radius: 0.5rem; }
        .food-card { background: #f0fdf4; }
        .misc-card { background: #faf5ff; }
        .card-title { font-weight: 600; margin-bottom: 0.5rem; }
        .food-title { color: #166534; }
        .misc-title { color: #7c3aed; }
        .budget-text { font-size: 0.75rem; color: #4b5563; margin-bottom: 0.25rem; }
        .amount { font-weight: bold; }
        .amount.positive { color: #166534; }
        .amount.negative { color: #dc2626; }
        .form-group { margin-bottom: 0.75rem; }
        .input, .select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; }
        .btn { width: 100%; padding: 0.5rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .expense-item { background: white; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; }
        .expense-info { flex: 1; }
        .expense-header { display: flex; align-items: center; margin-bottom: 0.25rem; }
        .category-tag { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 9999px; margin-right: 0.5rem; }
        .food-tag { background: #dcfce7; color: #166534; }
        .misc-tag { background: #f3e8ff; color: #7c3aed; }
        .empty-state { text-align: center; color: #6b7280; padding: 2rem; }
        .divider { border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.75rem; }
        .edit-input { padding: 0.25rem; border: 1px solid #9ca3af; border-radius: 0.25rem; width: 100%; }
        .edit-controls { display: flex; gap: 0.5rem; }
        .edit-btn { padding: 0.5rem 0.75rem; border: none; border-radius: 0.375rem; color: white; cursor: pointer; }
        .save-btn { background: #2563eb; }
        .cancel-btn { background: #6b7280; }
        .action-buttons { display: flex; gap: 0.5rem; align-items: center; }
        .delete-btn, .edit-action-btn {
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .delete-btn { background: #ef4444; }
        .edit-action-btn { background: #3b82f6; }
        .expense-date {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 0.25rem;
            width: 4rem;
            height: 4rem;
            color: #3b82f6;
            flex-shrink: 0;
        }
        .expense-date-day {
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1.2;
        }
        .expense-date-month {
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <div class="header-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">←</button>
                <div class="title">シンプル家計簿</div>
                <button class="nav-btn" onclick="changeMonth(1)">→</button>
            </div>
            <div class="month-display" id="monthDisplay"></div>
        </div>

    <!-- 週選択 -->
    <div class="section">
        <div class="week-grid" id="weekButtons"></div>
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; border-left: 4px solid #2563eb;">
            <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                <span style="font-size: 1rem; font-weight: 600; color: #1e40af;" id="currentWeekTitle"></span>
                <span style="margin-left: 0.5rem; color: #64748b; font-size: 0.875rem;" id="currentWeekInfo"></span>
            </div>
            <div style="font-size: 0.75rem; color: #475569;">
                食費予算: <span id="currentWeekBudgetDetail"></span> / 
                日額: <span id="dailyBudgetDetail"></span>
            </div>
        </div>
    </div>

    <!-- 予算表示 -->
    <div class="section">
        <div class="budget-grid">
            <div class="budget-card food-card">
                <div class="card-title food-title">食費</div>
                <div>
                    <div class="budget-text">週予算: <span id="weekBudget"></span></div>
                    <div class="amount positive" id="weekRemaining"></div>
                </div>
                <div class="divider">
                    <div class="budget-text">月予算: ¥45,000</div>
                    <div class="amount positive" id="monthRemaining"></div>
                </div>
            </div>
            <div class="budget-card misc-card">
                <div class="card-title misc-title">雑費</div>
                <div class="budget-text">予算: ¥55,000</div>
                <div class="amount positive" id="miscRemaining"></div>
            </div>
        </div>
    </div>

    <!-- 支出入力 -->
    <div class="section">
        <h2 style="font-weight: 600; margin-bottom: 0.75rem;">支出を追加</h2>
        <div class="form-group">
            <select id="category" class="select">
                <option value="food">食費</option>
                <option value="misc">雑費</option>
            </select>
        </div>
        <div class="form-group">
            <input type="text" id="item" placeholder="項目名（任意）" class="input">
        </div>
        <div class="form-group">
            <input type="number" id="amount" placeholder="金額" class="input">
        </div>
        <div class="form-group">
            <input type="date" id="date" class="input">
        </div>
        <button onclick="addExpense()" class="btn">追加</button>
    </div>

    <!-- 支出履歴 -->
    <div class="section">
        <h2 style="font-weight: 600; margin-bottom: 0.75rem;" id="expenseTitle"></h2>
        <div id="expenseList"></div>
    </div>
</div>

<script>
    // グローバル変数
    let currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
    let selectedWeek = 0;
    let expenses = [];
    let weeks = [];
    let editingExpenseId = null;

    // ローカルストレージから読み込み
    try {
        const saved = localStorage.getItem('budgetExpenses');
        if (saved) {
            expenses = JSON.parse(saved);
        }
    } catch (e) {
        expenses = [];
    }
    
    // ★ 日本のタイムゾーンでYYYY-MM-DD形式の文字列を返す関数
    function getLocalDateString(date = new Date()) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ★ 今日の日付を日本時間で設定
    document.getElementById('date').value = getLocalDateString();


    function getLastPayDay(year, month) {
        const lastDay = new Date(year, month, 0);
        let lastBusinessDay = new Date(lastDay);
        while (lastBusinessDay.getDay() === 0 || lastBusinessDay.getDay() === 6) {
            lastBusinessDay.setDate(lastBusinessDay.getDate() - 1);
        }
        let payDay = new Date(lastBusinessDay);
        payDay.setDate(payDay.getDate() - 1);
        if (payDay.getDay() === 0) { payDay.setDate(payDay.getDate() - 2); }
        else if (payDay.getDay() === 6) { payDay.setDate(payDay.getDate() - 1); }
        return payDay;
    }

    function calculateWeeks() {
        const [year, month] = currentMonth.split('-').map(Number);
        const startDate = getLastPayDay(year, month);
        const nextMonth = month === 12 ? 1 : month + 1;
        const nextYear = month === 12 ? year + 1 : year;
        const endDate = getLastPayDay(nextYear, nextMonth);
        const totalDaysInMonth = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const dailyFoodBudget = 45000 / totalDaysInMonth;
        const weekData = [];
        let currentDate = new Date(startDate);
        let totalAllocated = 0;
        
        for (let weekNum = 0; weekNum < 5; weekNum++) {
            if (currentDate > endDate) break;
            const weekStart = new Date(currentDate);
            let weekEnd;
            if (weekNum === 0) {
                const dayOfWeek = weekStart.getDay();
                const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
                weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + daysToSunday);
            } else {
                weekEnd = new Date(currentDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
            }
            if (weekEnd > endDate) { weekEnd = new Date(endDate); }
            
            const daysInWeek = Math.max(1, Math.ceil((weekEnd - weekStart) / (1000 * 60 * 60 * 24)) + 1);
            let foodBudget;
            if (weekNum === 4 || new Date(weekEnd).getTime() >= new Date(endDate).getTime()) {
                foodBudget = 45000 - totalAllocated;
            } else {
                foodBudget = Math.round(dailyFoodBudget * daysInWeek);
                totalAllocated += foodBudget;
            }
            
            weekData.push({
                id: weekNum,
                name: `${weekNum + 1}週目`,
                startDate: weekStart,
                endDate: weekEnd,
                foodBudget: foodBudget,
                daysInWeek: daysInWeek,
                period: `${weekStart.getMonth() + 1}/${weekStart.getDate()}〜${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`
            });
            
            currentDate = new Date(weekEnd);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return weekData;
    }

    function saveData() {
        try {
            localStorage.setItem('budgetExpenses', JSON.stringify(expenses));
        } catch (e) {
            console.error('データ保存に失敗しました');
        }
    }

    function changeMonth(direction) {
        const [year, month] = currentMonth.split('-').map(Number);
        let newDate = new Date(year, month - 1, 1);
        newDate.setMonth(newDate.getMonth() + direction);
        currentMonth = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}`;
        selectedWeek = 0;
        weeks = calculateWeeks();
        updateDisplay();
    }

    function selectWeek(weekIndex) {
        selectedWeek = weekIndex;
        editingExpenseId = null;
        updateDisplay();
    }

    function addExpense() {
        const category = document.getElementById('category').value;
        const item = document.getElementById('item').value || '-';
        const amount = parseInt(document.getElementById('amount').value);
        const date = document.getElementById('date').value;

        if (!amount || !date) { alert('金額と日付を入力してください'); return; }

        const expense = { id: Date.now(), category, item, amount, date, month: currentMonth, weekId: selectedWeek };
        expenses.push(expense);
        saveData();
        
        document.getElementById('item').value = '';
        document.getElementById('amount').value = '';
        // ★ 日付のリセットも日本時間で行う
        document.getElementById('date').value = getLocalDateString();
        updateDisplay();
    }

    function deleteExpense(id) {
        expenses = expenses.filter(expense => expense.id !== id);
        saveData();
        updateDisplay();
    }
    
    function startEdit(id) {
        editingExpenseId = id;
        updateDisplay();
    }

    function cancelEdit() {
        editingExpenseId = null;
        updateDisplay();
    }

    function saveEdit(id) {
        const newAmount = parseInt(document.getElementById(`edit-amount-${id}`).value);
        const newItem = document.getElementById(`edit-item-${id}`).value || '-';

        if (!newAmount || newAmount <= 0) { alert('有効な金額を入力してください'); return; }

        const expenseIndex = expenses.findIndex(e => e.id === id);
        if (expenseIndex > -1) {
            expenses[expenseIndex].amount = newAmount;
            expenses[expenseIndex].item = newItem;
        }
        editingExpenseId = null;
        saveData();
        updateDisplay();
    }

    function updateDisplay() {
        try {
            const [year, month] = currentMonth.split('-');
            const payDay = getLastPayDay(parseInt(year), parseInt(month));
            document.getElementById('monthDisplay').textContent = `${year}年${month}月 (${payDay.getMonth() + 1}/${payDay.getDate()}〜)`;

            const weekButtons = document.getElementById('weekButtons');
            weekButtons.innerHTML = '';
            weeks.forEach((week, i) => {
                const button = document.createElement('button');
                button.innerHTML = `<div class="week-title">${i + 1}週目</div><div class="week-date">${week.period}</div>`;
                button.className = `week-btn ${selectedWeek === i ? 'active' : 'inactive'}`;
                button.onclick = () => selectWeek(i);
                weekButtons.appendChild(button);
            });

            const currentWeek = weeks[selectedWeek];
            if (currentWeek) {
                document.getElementById('currentWeekTitle').textContent = `${selectedWeek + 1}週目`;
                document.getElementById('currentWeekInfo').textContent = `${currentWeek.period} (${currentWeek.daysInWeek}日間)`;
                document.getElementById('currentWeekBudgetDetail').textContent = `¥${currentWeek.foodBudget.toLocaleString()}`;
                const dailyBudget = Math.round(currentWeek.foodBudget / currentWeek.daysInWeek);
                document.getElementById('dailyBudgetDetail').textContent = `¥${dailyBudget.toLocaleString()}`;
            }

            const currentMonthExpenses = expenses.filter(e => e.month === currentMonth);
            const foodExpenses = currentMonthExpenses.filter(e => e.category === 'food');
            const weekFoodExpenses = foodExpenses.filter(e => e.weekId === selectedWeek);
            const totalFoodSpent = foodExpenses.reduce((sum, e) => sum + e.amount, 0);
            const weekFoodSpent = weekFoodExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            const weekBudget = currentWeek ? currentWeek.foodBudget : 0;
            const monthFoodRemaining = 45000 - totalFoodSpent;
            const weekFoodRemaining = weekBudget - weekFoodSpent;

            document.getElementById('weekBudget').textContent = `¥${weekBudget.toLocaleString()}`;
            document.getElementById('weekRemaining').textContent = `週残: ¥${weekFoodRemaining.toLocaleString()}`;
            document.getElementById('weekRemaining').className = `amount ${weekFoodRemaining >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('monthRemaining').textContent = `月残: ¥${monthFoodRemaining.toLocaleString()}`;
            document.getElementById('monthRemaining').className = `amount ${monthFoodRemaining >= 0 ? 'positive' : 'negative'}`;

            const miscExpenses = currentMonthExpenses.filter(e => e.category === 'misc');
            const totalMiscSpent = miscExpenses.reduce((sum, e) => sum + e.amount, 0);
            const miscRemaining = 55000 - totalMiscSpent;
            document.getElementById('miscRemaining').textContent = `残: ¥${miscRemaining.toLocaleString()}`;
            document.getElementById('miscRemaining').className = `amount ${miscRemaining >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('expenseTitle').textContent = `${selectedWeek + 1}週目の支出`;
            const expenseList = document.getElementById('expenseList');
            const weekExpenses = currentMonthExpenses.filter(e => e.weekId === selectedWeek);

            if (weekExpenses.length === 0) {
                expenseList.innerHTML = '<div class="empty-state">まだ支出がありません</div>';
            } else {
                expenseList.innerHTML = weekExpenses.map(expense => {
                    const expenseDate = new Date(expense.date);
                    // タイムゾーンのオフセットを考慮して日付を補正
                    const correctedDate = new Date(expenseDate.getTime() + expenseDate.getTimezoneOffset() * 60000);
                    const day = correctedDate.getDate();
                    const month = correctedDate.getMonth() + 1;
                    const dateHtml = `
                        <div class="expense-date">
                            <div class="expense-date-month">${month}月</div>
                            <div class="expense-date-day">${day}</div>
                        </div>`;

                    if (expense.id === editingExpenseId) {
                        return `
                        <div class="expense-item">
                            ${dateHtml}
                            <div class="expense-info">
                                <input type="text" id="edit-item-${expense.id}" value="${expense.item === '-' ? '' : expense.item}" class="edit-input" style="margin-bottom: 0.25rem;">
                                <input type="number" id="edit-amount-${expense.id}" value="${expense.amount}" class="edit-input">
                            </div>
                            <div class="edit-controls">
                                <button class="edit-btn save-btn" onclick="saveEdit(${expense.id})">保存</button>
                                <button class="edit-btn cancel-btn" onclick="cancelEdit()">中止</button>
                            </div>
                        </div>`;
                    } else {
                        const displayItem = (expense.item === '-' || !expense.item) ? (expense.category === 'food' ? '食費' : '雑費') : expense.item;
                        return `
                        <div class="expense-item">
                            ${dateHtml}
                            <div class="expense-info">
                                <div class="expense-header">
                                    <span class="category-tag ${expense.category === 'food' ? 'food-tag' : 'misc-tag'}">
                                        ${expense.category === 'food' ? '食費' : '雑費'}
                                    </span>
                                    <span>${displayItem}</span>
                                </div>
                                <div style="font-size: 1.125rem; font-weight: bold;">¥${expense.amount.toLocaleString()}</div>
                            </div>
                            <div class="action-buttons">
                                <button class="edit-action-btn" onclick="startEdit(${expense.id})">修正</button>
                                <button class="delete-btn" onclick="deleteExpense(${expense.id})">削除</button>
                            </div>
                        </div>`;
                    }
                }).join('');
            }
        } catch (error) {
            console.error('表示更新でエラーが発生しました:', error);
        }
    }

    function initialize() {
        try {
            weeks = calculateWeeks();
            updateDisplay();
        } catch (error) {
            console.error('初期化でエラーが発生しました:', error);
            weeks = [];
            updateDisplay();
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>

